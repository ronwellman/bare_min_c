\documentclass[../main.tex]{subfiles}

\graphicspath{{pictures/}{../pictures/}}

\chapterimage{chapter_head_8.pdf} % Chapter heading image

\begin{document}
	%----------------------------------------------------------------------------------------
	%	Multithreading
	%----------------------------------------------------------------------------------------
	\chapter{Networking}\index{Networking}\label{ch:networking}
	In this chapter I'll walk through a couple of examples using \textit{sockets} to send information back and forth between a client and a server application.  However, I am not going to go into any great depth.  What I actually suggest is to visit Brian "Beej Jorgensen" Hall's website at \url{http://beej.us/guide/bgnet/}.  His Guide to Network Programming \cite{beej_network_programming} is a much more thorough resource.  I personally look at it nearly every time I use \textit{sockets} and I've had other programmers mention they do the same. Go browse it now.  Going forward, I'm going to assume you have.
	
	First things first, you need to make a few decisions about the application you're building.  You'll need to decide whether you will be using TCP or UDP. You'll also need to decide whether you'll be working with IPv4, IPv6, or both.
	
	Additionally, there is the concept of endianness.  Most end systems are little-endian these days and most networks utilize big-endian.  You will therefore often find yourself translating between the two when sending data between systems.
	
	Lets jump into a very simple example of a threaded server application talking to a single remote client: \\
	
	\lstinputlisting[caption={\lstname}, label={lst:networking1}]{src/08-network1_server.c}
	
	AS we can see on lines 18-19 we create two \textit{sockaddr\_in structs} to hold our addresses both our local \textit{socket} address and remote connections.  
	
	On line 23 we use the \textit{socket} function to create a file descriptor.  In this instance, we are passing in AF_INET (IPv4) and SOCK_STREAM (TCP).
	
	In lines 29-31 we are manually packing our address.  We once again specify we will be using IPv4.  We also use \textit{htons} (Host to Network Short) to convert the port number to big-endian.  Lastly we use \textit{inet\_pton} (Presentation to Network) to convert the ip address (string) to a network address.
	
	Lets see what this looks like when we run it.
	
	\begin{verbatim}
	$ ./10-network1-server 
	Accepted a connection from: 127.0.0.1:39412
	\end{verbatim}
	
	In one tab we fire up our server and once our client (in another tab) connects, we see its IP address and source port.  We can verify this by running \texttt{netstat -plantu | grep 8888}.  
	
	\begin{verbatim}
	tcp        0      0 127.0.0.1:8888          127.0.0.1:39412         ESTABLISHED 9325/./10-network1- 
	\end{verbatim}
	
	Now lets see what this looks like from a client:
	
	\begin{verbatim}
	$ nc localhost 8888
	Marco
	Polo
	Marco
	NotPolo
	
	\end{verbatim}
	
	In another tab, we are connecting to the server via the program \texttt{netcat}.  I am immediately sent "Marco" from the server and I respond with "Polo".  I am once again sent "Marco" and I respond with "NotPolo".  When the server sees this, it drops my connection.  After hitting <ENTER> in \texttt{netcat} I am returned to the prompt.
	
\end{document}